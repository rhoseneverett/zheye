import{d as V,k as f,s as q,a as $,b as t,v as P,x as I,y as E,q as M,o as S,j as R,z as j,g as z,e as U,t as x,w as v,m as B,n as k}from"./index-DyRkbYjn.js";import{_ as N,a as C}from"./ValidateInput.vue_vue_type_script_setup_true_lang-C88jyHzX.js";import{b as T}from"./helper-TXTB4Bdo.js";import{u as A}from"./post-BMlZJ4gU.js";import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";const J={class:"file-upload"},H=V({inheritAttrs:!1,__name:"Uploader",props:{action:{},beforeUpload:{type:Function},uploaded:{}},emits:["file-uploaded","file-uploaded-error"],setup(h,{emit:c}){const l=h,b=c,p=f(null),y=()=>{p.value&&p.value.click()},u=f(l.uploaded),r=f(l.uploaded?"success":"ready");q(()=>l.uploaded,s=>{s&&(r.value="success",u.value=s)});const g=async s=>{const o=s.target;if(o.files)try{const n=Array.from(o.files);if(l.beforeUpload&&!l.beforeUpload(n[0]))return;r.value="loading";const _=new FormData;_.append("file",n[0]);const m=await M.post(l.action,_,{headers:{"Content-Type":"multipart/form-data"}});console.log(m),u.value=m.data,b("file-uploaded",m.data),r.value="success"}catch(n){b("file-uploaded-error",n),r.value="error"}finally{p.value&&(p.value.value="")}};return(s,o)=>(S(),$("div",J,[t("div",I({class:"file-upload-container",onClick:E(y,["prevent"])},s.$attrs),[r.value==="loading"?P(s.$slots,"loading",{key:0},()=>[o[0]||(o[0]=t("button",{class:"btn btn-primary",disabled:""},"正在上传...",-1))]):r.value==="success"?P(s.$slots,"uploaded",{key:1,uploadedData:u.value},()=>[o[1]||(o[1]=t("button",{class:"btn btn-primary"},"上传成功",-1))]):P(s.$slots,"default",{key:2},()=>[o[2]||(o[2]=t("button",{class:"btn btn-primary"},"点击上传",-1))])],16),t("input",{type:"file",class:"file-input d-none",ref_key:"fileInput",ref:p,onChange:g},null,544)]))}}),K={class:"create-post-page"},L=["src"],O={class:"mb-3"},Q={class:"mb-3"},W={class:"btn btn-primary btn-large"},X=V({__name:"CreatePost",setup(h){const c=f(""),l=A(),b=R(),p=B(),y=j(),u=!!y.query.id,r=f(),g=y.query.id;z(async()=>{if(u){const a=await l.fetchPost(g);a.image&&(r.value={data:a.image}),c.value=a.title,n.value=a.content||""}});let s="";const o=[{type:"required",message:"文章标题不能为空"}],n=f(""),_=[{type:"required",message:"文章详情不能为空"}],m=a=>{a.data._id&&(s=a.data._id)},w=async a=>{if(a){const{column:e,_id:d}=b.data;if(e){const i={title:c.value,content:n.value,column:e,author:d};s&&(i.image=s),u?await l.updatePost(g,i):await l.createPost(i),k("发表成功，2秒后跳转到文章","success",2e3),setTimeout(()=>{p.push({name:"column",params:{id:e}})},2e3)}}},D=a=>{const e=T(a,{format:["image/jpeg","image/png"],size:1}),{passed:d,error:i}=e;return i==="format"&&k("上传图片只能是 JPG/PNG 格式!","error"),i==="size"&&k("上传图片大小不能超过 1Mb","error"),d},F=a=>{k(`上传图片出现错误 ${a}`,"error")};return(a,e)=>(S(),$("div",K,[t("h3",null,x(u?"更新文章":"发表文章"),1),U(H,{action:"/upload",uploaded:r.value,class:"d-flex align-items-center justify-content-center bg-light text-secondary w-100 my-4",beforeUpload:D,onFileUploaded:m,onFileUploadedError:F},{loading:v(()=>e[2]||(e[2]=[t("div",{class:"d-flex"},[t("div",{class:"spinner-border text-secondary",role:"status"},[t("span",{class:"sr-only"})]),t("h2",null,"正在上传")],-1)])),uploaded:v(d=>{var i;return[t("img",{src:(i=d.uploadedData)==null?void 0:i.data.url},null,8,L)]}),default:v(()=>[e[3]||(e[3]=t("h2",null,"点击上传图片",-1))]),_:1},8,["uploaded"]),U(N,{onFormSubmit:w},{submit:v(()=>[t("button",W,x(u?"更新文章":"发表文章"),1)]),default:v(()=>[t("div",O,[e[4]||(e[4]=t("label",{class:"form-label"},"文章标题：",-1)),U(C,{rules:o,modelValue:c.value,"onUpdate:modelValue":e[0]||(e[0]=d=>c.value=d),placeholder:"请输入文章标题",type:"text"},null,8,["modelValue"])]),t("div",Q,[e[5]||(e[5]=t("label",{class:"form-label"},"文章详情：",-1)),U(C,{rows:"10",type:"text",tag:"textarea",placeholder:"请输入文章详情",rules:_,modelValue:n.value,"onUpdate:modelValue":e[1]||(e[1]=d=>n.value=d)},null,8,["modelValue"])])]),_:1})]))}}),se=G(X,[["__scopeId","data-v-139d096f"]]);export{se as default};
